{
  "openapi": "3.1.0",
  "info": {
    "title": "NodeLoc OAuth2 API",
    "description": "NL OAuth2是一个基于Discourse的SSO的身份认证服务，允许应用程序使用NL用户系统进行身份验证和授权。",
    "version": "1.0.0",
    "contact": {
      "name": "NodeLoc Team",
      "url": "https://conn.nodeloc.cc"
    },
    "license": {
      "name": "MIT"
    }
  },
  "servers": [
    {
      "url": "https://conn.nodeloc.cc",
      "description": "Production server"
    }
  ],
  "security": [
    {
      "basicAuth": []
    },
    {
      "bearerAuth": []
    }
  ],
  "paths": {
    "/oauth2/auth": {
      "get": {
        "summary": "授权端点",
        "description": "获取授权码的端点，用于启动OAuth2授权码流程",
        "operationId": "authorize",
        "tags": ["OAuth2"],
        "parameters": [
          {
            "name": "response_type",
            "in": "query",
            "required": true,
            "description": "响应类型，必须为 'code'",
            "schema": {
              "type": "string",
              "enum": ["code"]
            },
            "example": "code"
          },
          {
            "name": "client_id",
            "in": "query",
            "required": true,
            "description": "应用的Client ID",
            "schema": {
              "type": "string"
            },
            "example": "abcd1234567890ef"
          },
          {
            "name": "redirect_uri",
            "in": "query",
            "required": true,
            "description": "授权后的回调地址",
            "schema": {
              "type": "string",
              "format": "uri"
            },
            "example": "https://myapp.com/auth/callback"
          },
          {
            "name": "scope",
            "in": "query",
            "required": false,
            "description": "请求的权限范围",
            "schema": {
              "type": "string"
            },
            "example": "openid profile"
          },
          {
            "name": "state",
            "in": "query",
            "required": false,
            "description": "防CSRF的随机字符串",
            "schema": {
              "type": "string"
            },
            "example": "random_state_string"
          }
        ],
        "responses": {
          "302": {
            "description": "重定向到回调地址，携带授权码",
            "headers": {
              "Location": {
                "description": "重定向URL，包含授权码和state参数",
                "schema": {
                  "type": "string",
                  "format": "uri"
                },
                "example": "https://myapp.com/auth/callback?code=auth_code_here&state=random_state_string"
              }
            }
          },
          "400": {
            "description": "请求参数错误",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/OAuthError"
                }
              }
            }
          },
          "403": {
            "description": "用户拒绝授权",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/OAuthError"
                }
              }
            }
          }
        }
      }
    },
    "/oauth2/token": {
      "post": {
        "summary": "令牌端点",
        "description": "交换访问令牌或刷新令牌的端点",
        "operationId": "getToken",
        "tags": ["OAuth2"],
        "security": [
          {
            "basicAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/x-www-form-urlencoded": {
              "schema": {
                "oneOf": [
                  {
                    "$ref": "#/components/schemas/AuthorizationCodeRequest"
                  },
                  {
                    "$ref": "#/components/schemas/RefreshTokenRequest"
                  }
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "成功获取令牌",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TokenResponse"
                }
              }
            }
          },
          "400": {
            "description": "请求错误",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/OAuthError"
                }
              }
            }
          },
          "401": {
            "description": "客户端认证失败",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/OAuthError"
                }
              }
            }
          }
        }
      }
    },
    "/oauth2/userinfo": {
      "get": {
        "summary": "用户信息端点",
        "description": "获取当前用户信息的端点",
        "operationId": "getUserInfo",
        "tags": ["OAuth2"],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "用户信息",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UserInfo"
                }
              }
            }
          },
          "401": {
            "description": "访问令牌无效或过期",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/OAuthError"
                }
              }
            }
          }
        }
      }
    },
    "/apps": {
      "get": {
        "summary": "获取应用列表",
        "description": "获取当前用户创建的OAuth2应用列表",
        "operationId": "getApps",
        "tags": ["应用管理"],
        "responses": {
          "200": {
            "description": "应用列表",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/Application"
                  }
                }
              }
            }
          },
          "401": {
            "description": "未认证",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/api/apps": {
      "get": {
        "summary": "获取应用列表 (API)",
        "description": "通过API获取应用列表",
        "operationId": "getAppsApi",
        "tags": ["应用管理"],
        "responses": {
          "200": {
            "description": "应用列表",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/Application"
                  }
                }
              }
            }
          }
        }
      },
      "post": {
        "summary": "创建应用",
        "description": "创建新的OAuth2应用",
        "operationId": "createApp",
        "tags": ["应用管理"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateApplicationRequest"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "应用创建成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CreateApplicationResponse"
                }
              }
            }
          },
          "400": {
            "description": "请求参数错误",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    }
  },
  "webhooks": {
    "/plant/webhook": {
      "post": {
        "summary": "用户授权通知",
        "description": "当用户完成OAuth2授权时的webhook通知",
        "requestBody": {
          "description": "授权完成通知",
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/AuthorizationWebhook"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Webhook接收成功"
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "AuthorizationCodeRequest": {
        "type": "object",
        "required": ["grant_type", "code", "redirect_uri"],
        "properties": {
          "grant_type": {
            "type": "string",
            "enum": ["authorization_code"],
            "description": "授权类型，必须为 'authorization_code'"
          },
          "code": {
            "type": "string",
            "description": "从授权端点获取的授权码"
          },
          "redirect_uri": {
            "type": "string",
            "format": "uri",
            "description": "必须与授权时的URI一致"
          }
        },
        "example": {
          "grant_type": "authorization_code",
          "code": "auth_code_here",
          "redirect_uri": "https://myapp.com/auth/callback"
        }
      },
      "RefreshTokenRequest": {
        "type": "object",
        "required": ["grant_type", "refresh_token"],
        "properties": {
          "grant_type": {
            "type": "string",
            "enum": ["refresh_token"],
            "description": "授权类型，必须为 'refresh_token'"
          },
          "refresh_token": {
            "type": "string",
            "description": "刷新令牌"
          }
        },
        "example": {
          "grant_type": "refresh_token",
          "refresh_token": "refresh_token_here"
        }
      },
      "TokenResponse": {
        "type": "object",
        "required": ["access_token", "token_type", "expires_in"],
        "properties": {
          "access_token": {
            "type": "string",
            "description": "访问令牌"
          },
          "token_type": {
            "type": "string",
            "enum": ["Bearer"],
            "description": "令牌类型"
          },
          "expires_in": {
            "type": "integer",
            "description": "访问令牌过期时间（秒）"
          },
          "refresh_token": {
            "type": "string",
            "description": "刷新令牌（可选）"
          },
          "id_token": {
            "type": "string",
            "description": "ID令牌（JWT格式）"
          }
        },
        "example": {
          "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
          "token_type": "Bearer",
          "expires_in": 3600,
          "refresh_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
          "id_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
        }
      },
      "UserInfo": {
        "type": "object",
        "required": ["sub", "username"],
        "properties": {
          "sub": {
            "type": "string",
            "description": "用户ID"
          },
          "username": {
            "type": "string",
            "description": "用户名"
          },
          "email": {
            "type": "string",
            "format": "email",
            "description": "邮箱地址"
          },
          "groups": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "用户所属的组"
          }
        },
        "example": {
          "sub": "123",
          "username": "john_doe",
          "email": "john@example.com",
          "groups": ["developers", "admins"]
        }
      },
      "Application": {
        "type": "object",
        "required": ["client_id", "name", "owner_username", "created_at"],
        "properties": {
          "client_id": {
            "type": "string",
            "description": "应用ID"
          },
          "name": {
            "type": "string",
            "description": "应用名称"
          },
          "description": {
            "type": "string",
            "description": "应用描述"
          },
          "owner_username": {
            "type": "string",
            "description": "创建者用户名"
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "description": "创建时间"
          },
          "redirect_uris": {
            "type": "array",
            "items": {
              "type": "string",
              "format": "uri"
            },
            "description": "重定向URI列表"
          }
        },
        "example": {
          "client_id": "abcd1234567890ef",
          "name": "My App",
          "description": "My OAuth2 Application",
          "owner_username": "john_doe",
          "created_at": "2024-01-01T00:00:00Z",
          "redirect_uris": ["https://myapp.com/auth/callback"]
        }
      },
      "CreateApplicationRequest": {
        "type": "object",
        "required": ["name", "redirect_uris"],
        "properties": {
          "name": {
            "type": "string",
            "description": "应用名称",
            "minLength": 1,
            "maxLength": 100
          },
          "description": {
            "type": "string",
            "description": "应用描述",
            "maxLength": 500
          },
          "redirect_uris": {
            "type": "array",
            "items": {
              "type": "string",
              "format": "uri"
            },
            "description": "重定向URI列表",
            "minItems": 1
          },
          "allow_groups": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "允许的用户组"
          },
          "deny_groups": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "拒绝的用户组"
          }
        },
        "example": {
          "name": "My App",
          "description": "My OAuth2 Application",
          "redirect_uris": ["https://myapp.com/auth/callback"],
          "allow_groups": ["developers"],
          "deny_groups": ["banned"]
        }
      },
      "CreateApplicationResponse": {
        "type": "object",
        "required": ["client_id", "client_secret", "name"],
        "properties": {
          "client_id": {
            "type": "string",
            "description": "生成的应用ID"
          },
          "client_secret": {
            "type": "string",
            "description": "生成的客户端密钥（只显示一次）"
          },
          "name": {
            "type": "string",
            "description": "应用名称"
          },
          "description": {
            "type": "string",
            "description": "应用描述"
          }
        },
        "example": {
          "client_id": "abcd1234567890ef",
          "client_secret": "secret_xyz123",
          "name": "My App",
          "description": "My OAuth2 Application"
        }
      },
      "AuthorizationWebhook": {
        "type": "object",
        "required": ["event", "user_id", "client_id"],
        "properties": {
          "event": {
            "type": "string",
            "enum": ["authorization_granted", "authorization_revoked"],
            "description": "事件类型"
          },
          "user_id": {
            "type": "string",
            "description": "用户ID"
          },
          "client_id": {
            "type": "string",
            "description": "应用ID"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "事件时间"
          }
        },
        "example": {
          "event": "authorization_granted",
          "user_id": "123",
          "client_id": "abcd1234567890ef",
          "timestamp": "2024-01-01T12:00:00Z"
        }
      },
      "OAuthError": {
        "type": "object",
        "required": ["error"],
        "properties": {
          "error": {
            "type": "string",
            "enum": [
              "invalid_request",
              "invalid_client",
              "invalid_grant",
              "unauthorized_client",
              "unsupported_grant_type",
              "invalid_scope",
              "access_denied",
              "invalid_redirect_uri"
            ],
            "description": "OAuth2错误代码"
          },
          "error_description": {
            "type": "string",
            "description": "错误描述"
          }
        },
        "example": {
          "error": "invalid_client",
          "error_description": "Client authentication failed"
        }
      },
      "Error": {
        "type": "object",
        "required": ["error", "message"],
        "properties": {
          "error": {
            "type": "integer",
            "format": "int32",
            "description": "错误代码"
          },
          "message": {
            "type": "string",
            "description": "错误消息"
          }
        },
        "example": {
          "error": 400,
          "message": "Bad Request"
        }
      }
    },
    "securitySchemes": {
      "basicAuth": {
        "type": "http",
        "scheme": "basic",
        "description": "使用 Client ID 和 Client Secret 进行 Basic 认证"
      },
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "使用访问令牌进行 Bearer 认证"
      }
    }
  },
  "tags": [
    {
      "name": "OAuth2",
      "description": "OAuth2 认证相关的端点"
    },
    {
      "name": "应用管理",
      "description": "OAuth2 应用管理相关的端点"
    }
  ]
}